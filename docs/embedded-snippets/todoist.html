<html>
  <head>
    <!-- Monaco library script is loaded from: https://cdnjs.com/libraries/monaco-editor-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs/loader.min.js"
      integrity="sha512-SExj71Cw3B9C9EE8BC/ad3AKia5zQXDj/2SM4THgkeKh5GIFZhKM/R3uclUG8YZwJrjcVhydAlIHmfNvsBCKZA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      require.config({
        paths: {
          vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs',
        },
      });

      require(['vs/editor/editor.main'], function () {
        var editor = monaco.editor.create(document.getElementById('container'), {
          value: "// **This import statement gives you access to all parts of the Coda Packs SDK. Uncomment to start!**\n// import * as coda from '@codahq/packs-sdk';\n\n// This line creates your new Pack.\nexport const pack = coda.newPack();\n\n// We use \"user authentication\" so that users of this Pack will provide their own credentials,\n// as opposed to \"system authentication\", which the pack author provides a single set of credentials\n// that apply to all requests from this pack.\n// In this case, users must grab the API token from the \"Integrations\" tab within Todoist's settings\npack.setUserAuthentication({type: coda.AuthenticationType.HeaderBearerToken});\n\n// When using the fetcher, this is the domain of the API that your pack makes fetcher requests to.\npack.addNetworkDomain('api.todoist.com');\n\n// The following adds a new formula to this Pack.\npack.addFormula({\n  // Remember, the formula name cannot have spaces in it.\n  name: 'AddProject',\n  description: 'Add a Todoist project',\n  parameters: [\n    coda.makeParameter({\n      type: coda.ParameterType.String,\n      name: 'title',\n      description: 'The title or name of your new project',\n    }),\n  ],\n  execute: async function ([title], context) {\n    // This formula makes an HTTP Post request to create a new project.\n    await context.fetcher.fetch({\n      url: `https://api.todoist.com/rest/v1/projects`,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n\n      // The project is created with the given title. No other fields are needed.\n      body: JSON.stringify({\n        name: title,\n      }),\n    });\n    // We don't necessarily have to return anything, but it's useful to return\n    // some kind of non-empty values that callers can use to check whether this\n    // button action has already been taken. Often it's a good idea to return the\n    // id of the object that was created, if possible.\n    return 'OK';\n  },\n  // This is an action, so it will show up as a button in the Coda UI.\n  isAction: true,\n  // This formula requires that a user has connected a Todoist account.\n  connectionRequirement: coda.ConnectionRequirement.Required,\n\n  // This formula returns a simple string upon completion, per line 46 above.\n  resultType: coda.ValueType.String,\n});\n\npack.addFormula({\n  name: 'AddTask',\n  description: 'Add a task.',\n\n  // This formula takes two parameters: the task, and the project it is to be added to.\n  parameters: [\n    coda.makeParameter({\n      type: coda.ParameterType.String,\n      name: 'content',\n      description: 'Content of the task.',\n    }),\n\n    // The project is an optional field. If not provided, it defaults to the inbox per Todoist's documentation.\n    coda.makeParameter({\n      type: coda.ParameterType.Number,\n      name: 'project',\n      description: 'project ID. if blank, will default to inbox.',\n      optional: true,\n    }),\n  ],\n  execute: async function ([title, id], context) {\n    await context.fetcher.fetch({\n      url: `https://api.todoist.com/rest/v1/tasks`,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        content: title,\n        project_id: id,\n      }),\n    });\n    return 'OK';\n  },\n  isAction: true,\n  connectionRequirement: coda.ConnectionRequirement.Required,\n  resultType: coda.ValueType.String,\n});\n\npack.addFormula({\n  name: 'MarkAsComplete',\n  description: 'Mark a task as completed.',\n  parameters: [\n    coda.makeParameter({\n      type: coda.ParameterType.String,\n      name: 'taskId',\n      description: 'The ID of the task to be marked as complete.',\n    }),\n  ],\n\n  // This formula makes a POST request to a designated URL constructed from the task ID.\n  execute: async function ([id], context) {\n    await context.fetcher.fetch({\n      url: `https://api.todoist.com/rest/v1/tasks/${id}/close`,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n    return 'OK';\n  },\n  isAction: true,\n  connectionRequirement: coda.ConnectionRequirement.Required,\n  resultType: coda.ValueType.String,\n});\n\n// Here, we define the two schemas for our sync tables (tasks and projects).\nconst taskSchema = coda.makeObjectSchema({\n  type: coda.ValueType.Object,\n\n  // These properties are applied to each row and will be used to define other information about this schema below.\n  properties: {\n    task: {type: coda.ValueType.String},\n    projectId: {type: coda.ValueType.Number},\n    id: {type: coda.ValueType.Number},\n  },\n\n  // The 'primary' property defines which field from this object will render in\n  // the object chip in the UI.\n  primary: 'task',\n\n  // The 'featured' array defines which of the above properties should have columns\n  // created for them by default. If your schema has lots of properties, it's often\n  // a good idea to only feature some of them so the table doesn't have an overwhelming\n  // number of columns. Users can always add additional columns for non-featured properties\n  // at any time.\n  featured: ['projectId'],\n\n  // 'id' is the property that acts as the unique id of each row.\n  // Entities being synced must have unique, stable ids in order for rows to be updated\n  // in-place on subsequent syncs.\n  id: 'id',\n});\n\nconst projectSchema = coda.makeObjectSchema({\n  type: coda.ValueType.Object,\n  primary: 'name',\n  featured: ['projectId'],\n  id: 'projectId',\n  properties: {\n    name: {type: coda.ValueType.String},\n    projectId: {type: coda.ValueType.Number},\n  },\n});\n\npack.addSyncTable({\n  // This is the name of the table displayed to users.\n  name: 'Tasks',\n  // This is a unique identifier for this table, used internally by Coda.\n  identityName: 'TaskTitle',\n  schema: taskSchema,\n  // Users must have a connection to Todoist to sync in tasks.\n  connectionRequirement: coda.ConnectionRequirement.Required,\n  formula: {\n    name: 'Tasks',\n    description: 'Sync current tasks',\n    parameters: [],\n\n    // Unlike canvas formulas, sync table formulas may run multiple times to get\n    // multiple pages of results, based on whether you return a \"continuation\".\n    execute: async function ([], context) {\n      const url = 'https://api.todoist.com/rest/v1/tasks';\n      const response = await context.fetcher.fetch({method: 'GET', url});\n      const result = [];\n\n      // Here, we add the relevant properties from the returned JSON per task to a new array.\n      for (const taskObj of response.body) {\n        result.push({\n          task: taskObj.content,\n          projectId: taskObj.project_id,\n          id: taskObj.id,\n        });\n      }\n\n      return {\n        result,\n        // Todoist returns all tasks at once, so this formula only needs to run once to fill the sync table.\n        continuation: undefined,\n      };\n    },\n  },\n});\n\npack.addSyncTable({\n  name: 'Projects',\n  schema: projectSchema,\n  identityName: 'Project',\n  connectionRequirement: coda.ConnectionRequirement.Required,\n  formula: {\n    name: 'Projects',\n    description: 'Sync open projects',\n    parameters: [],\n    execute: async function ([], context) {\n      const url = `https://api.todoist.com/rest/v1/projects`;\n      const response = await context.fetcher.fetch({method: 'GET', url});\n\n      const result = [];\n\n      for (const project of response.body) {\n        result.push({\n          name: project.name,\n          projectId: project.id,\n        });\n      }\n\n      return {result};\n    },\n  },\n});",
          language: 'javascript',
          minimap: {enabled: false},
          readOnly: true,
          renderValidationDecorations: 'off',
          wordWrap: 'on',
          contextmenu: false,
        });
      });
    </script>
  </head>
  <body>
    <div id="container" style="position: absolute; top: 0; right: 16; bottom: 16; left: 0"></div>
  </body>
</html>
